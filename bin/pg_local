#!/usr/bin/env bash

pg_local_dir=${PGLOCAL-".postgresql"}

red="\033[0;31m"
green="\033[0;32m"
yellow="\033[0;33m"
cyan="\033[0;36m"
white="\033[0;37m"

pg_local_direnv() {
  if [ -z "`grep -s pg_local .envrc`" ]; then
    echo "source pg_local env" >> .envrc
    echo -e "PostgreSQL: ${cyan}installed${white}"
    direnv allow
  fi
}

pg_local_init() {
  if ! pg_local_initialized; then
    echo -en "PostgreSQL: ${white}"
    mkdir -p "$pg_local_dir"
    pg_ctl initdb -D $pg_local_dir -s -o "-A trust"
    echo -e "${green}initialized${white}"
  else
    return 1
  fi
}

pg_local_initialized() {
  [[ -d "$pg_local_dir" ]]
}

pg_local_env() {
  if pg_local_is_running; then
    export PGDATA=`pwd`/${pg_local_dir}
    export PGPORT=`pg_local_port`
  fi
}

pg_local_is_running() {
  [[ -n "`pg_ctl status -D $pg_local_dir | grep PID`" ]]
}

pg_local_port() {
  pg_ctl status -D $pg_local_dir | tail -n 1 | cut -d " " -f 5 | sed 's/"//g'
}

pg_local_start() {
  if ! pg_local_is_running; then
    local log="$pg_local_dir/postgresql.log"
    local port=$(ruby -r socket -e 'puts TCPServer.open(0).addr[1]')
    pg_ctl start -D "$pg_local_dir" -l "$log" -s -o "-p $port"
    echo -e "PostgreSQL: ${green}started${white}"
  fi
}

pg_local_status() {
  if pg_local_initialized; then
    if pg_local_is_running; then
      echo -e "PostgreSQL: ${green}running${white}"
    else
      echo -e "PostgreSQL: ${red}stopped${white}"
    fi
  else
    echo -e "PostgreSQL: ${yellow}uninitialized${white}"
  fi
}

pg_local_stop() {
  if pg_local_is_running; then
    pg_ctl stop -D "$pg_local_dir" -s
    echo -e "PostgreSQL: ${red}stopped${white}"
  fi
}

case $1 in
  init)
    if [ ! -d "$pg_local_dir" ]; then
      pg_local_init
    else
      echo -en "PostgreSQL: ${green}initialized${white}"
    fi
    ;;
  setup)
    pg_local_direnv
    ;;
  stop)
    pg_local_stop
    ;;
  start)
    pg_local_start
    ;;
  restart)
    pg_local_stop
    pg_local_start
    ;;
  status)
    pg_local_status
    ;;
  env)
    if pg_local_init; then
      pg_local_start
    else
      pg_local_status
    fi
    pg_local_env
    ;;
  *)
    echo "Usage: $(basename $0) <init|setup|stop|start|restart|status|env>"
esac
